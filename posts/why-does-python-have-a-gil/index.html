<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <title>为什么Python有一个GIL | shellfly&#39;s blog</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta name="description"
    content="GIL 🔗GIL是Global Interpreter Lock的缩写，也就是全局的解释器锁。CPython用GIL来保证同一时间只有一个线程在执行Python代码。所以即使多个线程被操作系统分配到CPU不同的核里，最终的效果还是线性执行，没法利用多核的优势。这也就导致了多线程程序的执行效率大大降低。">
<meta name="generator" content="Hugo 0.138.0">


<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="stylesheet" href="/%20/css/style.css">
<link rel="shortcut icon" href="/%20/images/favicon.ico" type="image/x-icon" />



      <script async src="https://www.googletagmanager.com/gtag/js?id=G-5PLT8T85ZH"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-5PLT8T85ZH');
        }
      </script>






  </head>

  <body>
    <nav class="navigation">
    
    <a href="/%20/"> <span class="arrow">←</span>Home</a>
    
    <a href="/%20/posts">Archive</a>
    <a href="/%20/tags">Tags</a>
    <a href="/%20/about">About</a>

    

    
</nav>


    <main class="main">
      

<section id="single">
  <h1 class="title">为什么Python有一个GIL</h1>

  <div class="tip">
    <span>
      Mar 19, 2018 17:14
    </span>
    <span class="split">
      ·
    </span>
    <span>
      
      957 words
      
    </span>
    <span class="split">
      ·
    </span>
    <span>
      2 minute read
    </span>
  </div>

  <div class="toc">
    <nav id="TableOfContents"></nav>
  </div>

  <div class="content">
    <h1 id="gil">GIL <a href="#gil" class="anchor">🔗</a></h1><p>GIL是Global Interpreter Lock的缩写，也就是全局的解释器锁。CPython用GIL来保证同一时间只有一个线程在执行Python代码。所以即使多个线程被操作系统分配到CPU不同的核里，最终的效果还是线性执行，没法利用多核的优势。这也就导致了多线程程序的执行效率大大降低。</p>
<p>所以Python里到底为什么一定要有一个GIL呢？</p>
<p>Python官方文档中关于GIL有一段简要的说明：</p>
<blockquote>
<p>Python interpreter is not fully thread-safe. In order to support multi-threaded Python programs, there’s a global lock, called the global interpreter lock or GIL.</p>
</blockquote>
<p>简单翻译一下就是：因为Python解释器（CPython）自身不是完全线程安全的，所以为了支持多线程的Python程序，需要有一个全局解释器锁，也就是GIL。</p>
<h1 id="线程安全thread-safe">线程安全（Thread Safe） <a href="#%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8thread-safe" class="anchor">🔗</a></h1><p>如果用C或者Java写过多线程程序，就会知道访问共享资源的时候都是需要加锁的。CPython顾名思义，就是用C实现的Python解释器，当启用多线程的时候，为了保证代码的正确性，就需要锁，而GIL就是一把超级大锁，每个线程开始执行之前都需要先获得GIL，其他没有获得GIL的线程保持在等待状态，而像JVM中则采用细粒度(fine-grained)的锁来保证线程安全。</p>
<p>通常有两种操作会导致线程释放GIL，一种是协作式的（cooperative），在执行I/O操作之前，线程会主动释放GIL。另一种是抢占式的（preemptive），线程执行一定时间后会被迫释放GIL。</p>
<p>但是并不是有了GIL后，就不需要再关心线程安全了。GIL只能保证Python的内部数据结构同一时间只有一个线程可以访问，其实是保证了单独的操作是线程安全的，不需要额外的保护措施。但是如果有特定顺序的连续调用，还是需要用户显式的加锁来控制程序的正确性，也就是《深入理解Java虚拟机》中描述的相对线程安全。</p>
<h1 id="gil的优点">GIL的优点 <a href="#gil%e7%9a%84%e4%bc%98%e7%82%b9" class="anchor">🔗</a></h1><p>使用GIL最重要的原因就是：它可以让单线程程序的速度非常快，不需要考虑锁的释放和获取，和用细粒度的锁来保证解释器状态相比，省了很多不必要的操作。</p>
<p>在集成C库时，也不需要担心线程安全，如果不是线程安全的，只需要在调用的时候先获取GIL即可。</p>
<p>PS:
人脑和python解释器一样也有个GIL，一次只能处理一件事，通过context switch来模拟多线程运行。所以学过Python后一定要记得一件事，开车时不要看手机。</p>

  </div>

  
  <div class="tags">
    
    <a href="https://shellfly.github.io/tags/python">Python</a>
    
  </div>
  

   
  <div id="comment">
    
    <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "shellfly" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>


</section>

    </main>
    
    <footer id="footer">
    

    <p class="copyright">
        
        若无特别声明，本网站作品采用<a 
    href="http://creativecommons.org/licenses/by-nc-sa/4.0/"
    
    
     
      target="_blank" 
      rel="noopener"
    
>
    知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议
</a>进行许可。
        
    </p>
    <p class="powerby">
        Powered by <a href="http://www.gohugo.io/">Hugo</a> Theme By <a
            href="https://github.com/nodejh/hugo-theme-cactus-plus">nodejh</a>
    </p>
</footer>

  </body>
</html>
